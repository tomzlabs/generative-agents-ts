# 2026-02-10

- Upgraded global top navigation to a premium pixel style with better mobile behavior.
- Refactored `VillageMap` UI into card-based layout and improved responsive structure.
- Added map render safety: dynamic `maxCanvasScale` and `effectiveScale` to avoid large-canvas blank rendering.
- Added safer contract-address copy handler with fallback alert.
- Updated app scroll container offsets to match new fixed nav height (`src/App.tsx`, `src/App.css`).
- Verified production build passes (`npm run build`).
- Unified Farm + Map visual tokens: introduced global `ga-card-surface`, `ga-chip`, `ga-btn` styles in `src/index.css` and applied them in `FarmingPage` and `VillageMap`.
- Farm UI now uses shared card/button hierarchy (hero chips, seed buttons, side panels, harvest/upgrade buttons).
- Updated `MyNFAPage` to share the same visual token system (`ga-card-surface`, `ga-btn`) used by Map/Farm, including status row, metrics, runtime panel, agent cards, and modal actions.
- Fine-grained visual unification pass: added shared form tokens (`ga-label`, `ga-field-grid`, `ga-input`, `ga-select`, `ga-textarea`, `ga-note-box`, `ga-code-box`, `ga-help-text`) and migrated MyNFA runtime/modal forms to those classes.
- Improved MyNFA small-screen behavior for runtime actions and BAP rows.
- Rewrote `README.md` to reflect current real status: Map/Farm/MyNFA features, ongoing visual unification, chain integration hooks, routes, env setup, and updated roadmap.
- Fixed farm walker deployment issue by embedding walker SVGs as in-code data URIs in `FarmingPage.tsx`, removing runtime dependency on untracked `/public/static/assets/farm/farmer-*.svg` files.
- Wired Farm page to on-chain contracts:
  - Added `farmAddress` in chain config with default `0x6c0e60C1B4E78a87C053103e6CCB6E379c76B2cf`.
  - Switched default token address to `0x7Bf7e3F3bE243F7A3cF009A1253e8e9fbD2a1AC3`.
  - Implemented live on-chain sync in `FarmingPage` (`getUserInfo/getUserAllLandIds/getUserPlantedSeed/getSeedMatureTime`) and write flows (`plantSeed/harvestSeed/levelUp`) with wallet signing.
  - Added UI handling for chain/local mode, missing land slots, farm sync status, and contract errors.
- Added on-chain shop UI in `FarmingPage`:
  - Purchase Land (`purchaseLand`) with quantity input, token cost preview, and auto-approve flow.
  - Purchase Seed (`purchaseSeed`) with quantity input based on selected crop, token cost preview, and auto-approve flow.
  - Added price reads from contract (`landPrice`, `seedPrice`) and post-purchase balance/farm refresh.
- Added dedicated Lottery page `/lottery`:
  - Top navigation now includes `LOTTERY`.
  - Implemented chain-driven round history from farm contract (`currentLotteryRound`, `roundDrawn`, `roundWinnerRandom`, `getRoundMaxLotteryNumber`, `getLotteryOwner`).
  - Displays per-round winner info (round, status, winning number, winner address, random/pool), supports refresh, and highlights connected wallet wins.
- Added crop mature countdown on farm plots:
  - Plot model now stores `matureAt`.
  - Every planted (not-ripe) plot shows real-time countdown badge on tile.
  - Chain mode countdown is based on contract mature time; local mode uses local crop timing.
- Improved post-purchase land refresh reliability:
  - Added stale-response guard for farm sync calls (sequence-based) to avoid older RPC responses overwriting latest state.
  - After `purchaseLand`, parse `LandPurchased` event logs to optimistically fill new land slots immediately.
  - Added delayed re-sync after purchase and surfaced total on-chain land count in UI.
- Enhanced seed buttons with hover tooltips:
  - Hover/focus on each seed now shows yield rule (lottery tickets), EXP gain, and seed unit price.
  - Seed EXP values are read from chain (`expPerSeed`) with defaults as fallback.
- Farm scalability + pool display updates:
  - Added prize pool display using `getContractTokenBalance(tokenAddress)` in farm status panel.
  - Removed 3x3 hard cap in chain mode: plot count now follows `getUserAllLandIds` length (e.g. 11 lands shows 11 plots).
  - Added empty-state message "暂无土地" when wallet has zero land.
  - Optimized land sync calls with batched RPC reads for planted seed + mature time.
- Land tile geometry fix:
  - Farm grid now computes dynamic rows/columns and sets container aspect ratio accordingly.
  - Each plot tile is explicitly forced to `1 / 1` ratio so every land renders as a square.
- Enlarged outer land container in farm scene:
  - Increased farm-bed wrapper width/height usage and padding for better visual scale.
- Enlarged overall farm scene area:
  - Increased page max width and boosted left-column layout ratio so the whole scene block appears larger.
  - Increased scene height profile in chain mode using responsive `aspectRatio + minHeight clamp`.
- Reduced single-tile visual size while keeping large scene:
  - Plot grid now centers tiles and caps each plot button max width to prevent oversized single land tiles.
- Grid auto-fit update for chain lands:
  - Removed fixed 3-column behavior in chain mode.
  - Chain land grid now uses `auto-fit` tile tracks (`minmax(96px, 118px)`) so row count adapts naturally to owned land count and available width.
- Unified local mode grid behavior with chain mode:
  - Local farm grid now also uses the same `auto-fit` tile layout and tile size cap for consistent rendering.
- Prize pool display reliability fix:
  - Decoupled prize pool sync from main farm sync to avoid one failing RPC blocking the other.
  - Added fallback strategy for pool reads: try `ERC20_TOKEN()` + `getContractTokenBalance`, then fallback to token `balanceOf(farmAddress)`.
  - Added explicit pool loading/error UI so failures are visible instead of silent `--`.
- Switched default farm contract address to `0x07CF9f355E78ebA0D71B8d0699577E284ed19cF2` in both `src/config/chain.ts` and `.env.example`.
- Synced "道具与农场状态" panel with on-chain data model:
  - Added reads for `currentLotteryRound` + `getUserLotteryCount`.
  - Chain mode inventory now shows planted crop counts from on-chain land state instead of local pseudo bag counts.
  - Added note in UI that current contract does not store seed/tool backpack quantities.
  - After `purchaseSeed`, now refreshes farm sync so panel reflects latest chain state.
- Added wallet disconnect UX in top navigation:
  - When connected, nav now shows address + `DISCONNECT` button.
  - Clicking disconnect clears current front-end wallet session state (`account`), so pages immediately return to disconnected mode.
- Improved farm RPC stability for intermittent `missing response for request` errors:
  - Added transient RPC retry wrapper for farm/holding/prize-pool reads.
  - Added in-flight guards to prevent overlapping sync requests during polling.
  - Reduced poll pressure (farm: 5s -> 7s, prize pool: 6s -> 9s).
  - Added friendlier error text for missing-response cases.
- Added multi-RPC automatic fallback for BSC reads:
  - Introduced `CHAIN_CONFIG.rpcUrls` with Chainlist-style BSC endpoints (`bsc-dataseed`, `bsc-dataseed1`, `bsc-dataseed2`).
  - Added shared `getReadProvider()` using `ethers.FallbackProvider(quorum=1)` for automatic failover.
  - Migrated read paths in `App`, `MintPage`, `LotteryPage`, and `FarmingPage` to the shared fallback provider.
  - Added optional `VITE_BSC_RPC_URLS` env setting (comma-separated).
- Enforced chain-only level upgrade:
  - Farm upgrade now always calls contract `levelUp()` and no longer performs local simulated level changes.
  - Upgrade button now requires connected wallet and updates farm + holding + prize pool after success.
- Reduced farm RPC frequency per UX request:
  - Removed periodic polling for farm sync and prize pool sync.
  - Chain data now fetches once on wallet connect, and refreshes only on user actions (plant/harvest/purchase/upgrade).
- Removed remaining chain polling in Mint page:
  - Deleted 10s `fetchContractData` interval in `MintPage`.
  - Mint contract reads now occur once on page load.
- Switched primary BSC RPC endpoint to `https://binance.llamarpc.com/` while keeping dataseed endpoints as backups.
- Switched to single RPC mode per request:
  - Only use `https://bsc-rpc.publicnode.com/` as the BSC RPC endpoint.
  - Removed `VITE_BSC_RPC_URLS` from env example/docs and simplified chain config to a single-url source.
- Lottery UI update:
  - Added prominent prize pool display card (contract token balance) on the Lottery page.
  - Added prize pool read fallback (`getContractTokenBalance` -> token `balanceOf(farmAddress)`).
  - Fully localized Lottery page UI copy to Chinese (title, KPIs, table headers, status labels, buttons).
- Farm scene UI tweak:
  - Moved prize pool display into the farmland map area (top-left overlay card) for better visibility.
  - Removed duplicate prize pool line from the right-side wallet panel.
- Full Chinese copy pass (UI-level):
  - Localized remaining visible English labels in Farm page (title, chips, KPI labels/subtitles, seed labels/tooltips, hover/status badges, loading text, level labels, and selected crop labels).
  - Localized top navigation labels and wallet actions (`连接钱包` / `退出钱包`).
  - Updated Lottery default token fallback text from `TOKEN` to `代币`.
- Added no-seed modal UX in Farm:
  - When user tries to plant without local seed inventory, show an in-page dialog instead of silent failure/alert.
  - Added modal backdrop/card styles for consistent pixel UI.
- Replaced Farm top-right action with a gameplay guide:
  - Changed the old `一键收获` button into `玩法指南`.
  - Added a scrollable whitepaper-style modal with six sections: gameplay loop, onboarding, seed/yield rules, upgrade rules, lottery flow, and fund distribution.
  - Removed legacy harvest-all handler/state to match new UX.
- Lottery page now shows player's ticket IDs:
  - Reads per-round ticket count from contract via `getUserLotteryCount(account, currentRound)`.
  - Derives and lists ticket numbers by scanning `getLotteryOwner(currentRound, number)` (descending, batched).
  - Added UI panel `我的本期彩票编号` with count, chip list, and scan cutoff hint when ticket pool is too large.
