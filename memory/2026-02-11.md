# 2026-02-11

- 修复 Farm 种子数量刷新：链上模式改为前端背包计数，购买种子后 +count，种植成功后 -1；移除会吞掉手动刷新的 in-flight 拦截；修复 FarmingPage 中缺失 ref 导致的构建报错。
- RPC 限流优化（Farm）：静态配置读取拆分为一次性缓存；地块同步移除 getSeedMatureTime（改为前端按合约公式计算成熟时间），每块地从 2 次读取降到 1 次；增加同步任务去重（同类请求并发合并）；去掉购买土地后的延迟二次重刷；购买种子后不再触发整图地块重拉。
- Farm RPC 进一步减压：农场同步改为仅在初始化与链上操作后触发；链上操作后改为后台单次同步（不阻塞交互），减少“连续种植卡住”；每地块只读 getUserPlantedSeed，并前端按合约公式估算成熟时间，去掉每地额外 matureTime 查询。
- NFA 运行模式锁定为旧合约：CHAIN_CONFIG.nfaAddress 固定旧地址，My NFA Runtime 面板强制 LEGACY_MODE=1 且禁用合约地址切换；旧合约不支持的 EXECUTOR/EXECUTE 控件在弹窗中隐藏。
- 修复钱包刷新断连与Farm奖池刷新：App 增加钱包会话自动恢复（eth_accounts + localStorage 标记）与 accountsChanged 监听；购买种子后改为单次刷新奖池；地块点击去掉 loadingFarm 全局禁用并改为按地块 pending，缓解连续种植卡顿。
- 切换默认 Farm 合约到 0xb1311c0bDF4D4f93f60244Ac5663b6Ff58972FaA（chain config 与 .env.example 同步）。
- Farm 种子库存改为链上读取：优先尝试合约库存 getter（若存在），否则回退到链上事件账本（SeedPurchased-SeedPlanted）增量同步；种子不足统一走 UI 弹窗，不再弹 alert。
- Farm 界面二次视觉升级：改为 HUD 风格（状态胶囊、主舞台强化边框、右侧信息栈、卡片光泽和交互动效统一），并保持移动端自适配与功能不变。
- Farm 第三轮 HUD 化：右侧改为三栏信息板（商店/背包/等级），钱包与操作提示全宽；桌面3列、平板2列、手机1列自适配，保持原有链上交互逻辑。
- Farm HUD 拥挤度优化：侧栏改为 auto-fit(minmax 220px) 自适应栅格，常见屏幕自动降为两栏；放大侧栏宽度与卡片内边距/行高，保留模块化但减少压迫感。
- 按需求移除“道具与农场状态”卡片，并将轮次/总土地合并到持仓卡，减少侧栏拥挤。
- 全站双语（中文/English）改造：新增全局 i18n 上下文与导航语言切换（持久化 localStorage），并接入 App/Navigation/Farm/Lottery/Mint/MyNFA/Map/Whitepaper；Farm 与 Lottery 的核心按钮、提示、弹窗与玩法说明均支持中英切换，构建通过。
- 新增测试地图页 `/testmap`：从导航可进入，地图中间集成 3x3 可交互农场层（选种、种植、成熟倒计时、收获、经验/升级、提示文案），并使用本地存储 `ga:map:farm-v1` 持久化，主 `/map` 页面保持原样。
- TestMap 合约对接：`/testmap` 现已接入 Farm 合约读写（读取用户等级/经验/土地ID/地块作物，链上种植 `plantSeed`、收获 `harvestSeed`、升级 `levelUp`），并根据是否连接钱包自动在“本地测试模式/链上模式”切换。
- TestMap 土地渲染改为不限制：链上模式下按 `getUserAllLandIds` 实际数量动态渲染地块（不再固定9格/3x3），0土地显示“暂无土地”；地块网格改为 auto-fit 并支持滚动。
- TestMap 植物状态迁移：每块地新增阶段展示（种子/发芽/成熟/可收获），链上同步纳入 `isMatured`，并将作物名显示改为中英可读（小麦/玉米/胡萝卜）。
- TestMap 地块植物视觉升级：将圆点替换为像素植物图形（按种子/发芽/成熟/可收获四阶段渲染），与 Farm 页风格对齐。

- TestMap 农场交互与大屏适配修复：地图拖动改为 pointer capture（支持鼠标/触屏拖拽），新增 test 模式 wheel 平移，防止“地图不可移动”；提升 test 场景高度与农场覆盖层尺寸，并增加 1360+/1800+ 大屏断点，扩大农场区域同时限制单地块尺寸避免过大。

- 按需求将 /farm 测试地图改为不可移动：禁用该模式下的指针拖拽监听，移除滚轮平移逻辑，并将 is-test-map 画布容器设为 overflow:hidden + 默认光标，确保地图背景静止。

- /farm(TestMap) 种子按钮新增悬停浮窗：显示单价、收获彩票数、EXP、持有数量；沿用旧农场 tooltip 风格（像素深色气泡）。

- 默认 Farm 合约地址切换为 0xC2e74D9D246feaD9eFD3435A8a1c5046E8c3C948（src/config/chain.ts 与 .env.example 同步）。

- 玩法指南文案重写为玩家可读版（/farm 与旧农场两处同步）：弱化合约函数术语，改为目标-上手-作物选择-升级价值-开奖流程-费用去向的操作指引。

- 农场奖池新增 U 估值展示：基于 DexScreener 代币价格换算并显示在奖池下方，带 60 秒缓存降低价格请求频率。

- 成熟时间规则统一：按等级计算 0.95^(level-1) 时间系数；Map 链上地块倒计时改为 baseDuration * 系数，Farm 基础成熟常量同步为 2 小时。

- Lottery 页面新增开奖倒计时卡片：目标固定为页面加载时“明天 14:30”，每秒更新并显示目标时间，归零后显示“已到开奖时间”。

- ABI 使用方式统一：Farm/Lottery/Map 不再各自维护字符串 ABI，改为统一读取 src/assets/abi.json（新增 src/config/farmAbi.ts），避免 ABI 漂移导致调用不一致。

- 增加代币授权自动重试：当交易报 could not decode result data / allowance 相关错误时，自动重新 approve(MaxUint256) 后重试一次（Map 农场与旧 Farm 页购买/升级流程）。
